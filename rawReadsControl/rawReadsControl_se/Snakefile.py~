#coding : utf-8
## Workflow quality control for fastq file generated by single-end sequencing

import os
import re

NUMRUN = os.environ.get("RUN")
FASTQDIR = os.environ.get("FASTQDIR")
WDIR = os.environ.get("WDIR","10 20")
ANALYSIS = os.environ.get("ANALYSIS", "10 20")
IDRUN = os.environ.get("IDRUN", "10 20")

#run = "Run_158_NS500-065_02.11.2016_JPM_BSoS"
#WDIR = "/gpfs/tgml/herault/qualityControl/"+run

print(""+FASTQDIR+"/")




workdir: WDIR + "/" + IDRUN

sampleID1=os.listdir(""+FASTQDIR+"/")
sampleID=[i for i in sampleID1 if os.path.isdir(FASTQDIR+"/"+i)]

print(sampleID)

rule r5_multiqc:
    """
    Create html report using multiqc 
    """
    input: expand("result/fastqc/{sample}/", sample = sampleID), expand("result/fastq_screen/{sample}/", sample = sampleID)
    output: report="result/general_report/multiqc/"
    params: run = NUMRUN, analysis = ANALYSIS
    threads: 1
    shell:"""multiqc -s -b " {params.report} sÃ©quenceur Illumina NS500, Application : {params.analysis}" --outdir {output.report} -c /gpfs/tgml/herault/qualityControl/config/.multiqc_config.yaml  result/
    """


rule r1_merge_gz:
    input: FASTQDIR+"/{sample}/"
    output: fastq_gz_R1 ="data/fastq/{sample}_R1_001.fastq.gz"
    threads: 1
    shell:"""
    cat {input}*L0*R1*.gz > {output.fastq_gz_R1}
    """


rule r2_gunzip:
    input: "data/fastq/{sample}_R1_001.fastq.gz"
    output: "data/fastq/{sample}_R1_001.fastq"
    threads: 1
    shell:"""
    gunzip --stdout {input} > {output}
    """

rule r3_fastQC:
    """
    Run FastQC v0.11.5 control analysis on fastq.
    """
    input:
        fastq="data/fastq/{sample}_R1_001.fastq.gz"
    output: report="result/fastqc/{sample}/"
    threads: 1
    shell:"""
    fastqc --quiet --outdir {output.report} -f fastq {input.fastq}
    """

rule r4_fastqScreen:
    """ 
    Run fastq_screen_v0.5.1 on fastq
    """
    input:
        fastq="data/fastq/{sample}_R1_001.fastq.gz",
	fastq_screen="/gpfs/tgml/apps/fastq_screen_v0.5.1/fastq_screen"
    output: report="result/fastq_screen/{sample}/"  
    threads: 4
    shell:"""
    {input.fastq_screen} --bowtie2 "--local" --subset 100000 --outdir {output} --aligner bowtie2 {input.fastq}
    """
        	


